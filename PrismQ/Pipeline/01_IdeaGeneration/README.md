# Stage 01: Idea Generation

## Purpose

Generate creative video ideas based on target audience demographics. This stage is the first in the pipeline and produces raw content ideas that will be developed in subsequent stages.

## Independence

This stage is **fully independent** and can be:
- Developed in its own repository
- Tested without other pipeline stages
- Deployed/versioned separately
- Swapped with alternative implementations

## Input Contract

```python
@dataclass
class IdeaGenerationInput:
    target_gender: str              # e.g., 'women', 'men', 'all'
    target_age: str                 # e.g., '18-23', '24-29', '30-39'
    idea_count: int = 20            # Number of ideas to generate
    source_stories: list[dict] | None = None  # Optional source stories
    additional_params: dict = field(default_factory=dict)
```

### Input Fields

- **target_gender** (required): The gender of the target audience
  - Valid values: `'women'`, `'men'`, `'all'`, `'non-binary'`
  
- **target_age** (required): The age bucket of the target audience
  - Valid values: `'18-23'`, `'24-29'`, `'30-39'`, `'40-49'`, `'50+'`
  
- **idea_count** (optional): Number of ideas to generate
  - Default: 20
  - Range: 1-100
  
- **source_stories** (optional): List of source stories to adapt
  - Each story should have: `id`, `title`, `content`
  
- **additional_params** (optional): Extra parameters for customization

## Output Contract

```python
@dataclass
class IdeaGenerationOutput:
    ideas: list[IdeaItem]           # List of generated ideas
    total_count: int                # Total number of ideas
    adapted_count: int              # Number adapted from sources
    generated_count: int            # Number LLM-generated
    metadata: dict = field(default_factory=dict)
```

### Output Fields

- **ideas**: List of `IdeaItem` objects, each containing:
  - `id`: Unique identifier (e.g., `'reddit_abc123'`, `'llm_001'`)
  - `content`: The idea content/description
  - `source`: Origin of idea (`'reddit_adapted'`, `'llm_generated'`)
  - `target_gender`: Target gender for this idea
  - `target_age`: Target age bucket
  - `created_at`: Timestamp of creation
  - `metadata`: Additional metadata (score, subreddit, etc.)

- **total_count**: Sum of adapted + generated ideas
- **adapted_count**: Ideas adapted from `source_stories`
- **generated_count**: Ideas generated by LLM

## Dependencies

This stage only depends on:

1. **Shared Infrastructure Interfaces**:
   - `IPipelineStage` - Base stage interface
   - `ILLMProvider` - For idea generation

2. **No Cross-Stage Dependencies**:
   - ❌ Does NOT import from `02_TextGeneration`
   - ❌ Does NOT import from `03_AudioGeneration`
   - ❌ Does NOT import from other pipeline stages
   - ✅ Only imports from `Infrastructure/Core/Shared/interfaces`

## Implementation Example

```python
from PrismQ.Infrastructure.Core.Shared.interfaces import (
    BasePipelineStage,
    IdeaGenerationInput,
    IdeaGenerationOutput,
    IdeaItem,
    ILLMProvider,
)
from datetime import datetime

class IdeaGenerationStage(BasePipelineStage[IdeaGenerationInput, IdeaGenerationOutput]):
    """
    Generates creative video ideas based on target audience.
    """
    
    def __init__(self, llm_provider: ILLMProvider):
        super().__init__(
            stage_name="IdeaGeneration",
            stage_id="01_idea_generation",
            version="1.0.0"
        )
        self.llm_provider = llm_provider
    
    async def _execute_impl(
        self, 
        input_data: IdeaGenerationInput
    ) -> IdeaGenerationOutput:
        """Execute idea generation."""
        
        ideas = []
        
        # Adapt source stories if provided
        if input_data.source_stories:
            adapted_ideas = await self._adapt_stories(
                input_data.source_stories,
                input_data.target_gender,
                input_data.target_age
            )
            ideas.extend(adapted_ideas)
        
        # Generate LLM ideas
        remaining = input_data.idea_count - len(ideas)
        if remaining > 0:
            generated_ideas = await self._generate_ideas(
                input_data.target_gender,
                input_data.target_age,
                remaining
            )
            ideas.extend(generated_ideas)
        
        return IdeaGenerationOutput(
            ideas=ideas,
            total_count=len(ideas),
            adapted_count=len([i for i in ideas if i.source == 'reddit_adapted']),
            generated_count=len([i for i in ideas if i.source == 'llm_generated']),
        )
    
    async def validate_input(self, input_data: IdeaGenerationInput) -> bool:
        """Validate input parameters."""
        valid_genders = ['women', 'men', 'all', 'non-binary']
        valid_ages = ['18-23', '24-29', '30-39', '40-49', '50+']
        
        if input_data.target_gender not in valid_genders:
            raise ValueError(f"Invalid gender: {input_data.target_gender}")
        
        if input_data.target_age not in valid_ages:
            raise ValueError(f"Invalid age: {input_data.target_age}")
        
        if input_data.idea_count <= 0 or input_data.idea_count > 100:
            raise ValueError(f"Idea count must be 1-100: {input_data.idea_count}")
        
        return True
    
    async def _adapt_stories(
        self, 
        stories: list[dict], 
        gender: str, 
        age: str
    ) -> list[IdeaItem]:
        """Adapt source stories into ideas."""
        ideas = []
        
        for story in stories:
            prompt = f"""
            Adapt this story for {gender} aged {age}:
            Title: {story.get('title', '')}
            Content: {story.get('content', '')}
            
            Create a compelling video idea.
            """
            
            content = self.llm_provider.generate_completion(
                prompt=prompt,
                temperature=0.7,
                max_tokens=300
            )
            
            ideas.append(IdeaItem(
                id=f"reddit_{story.get('id', 'unknown')}",
                content=content.strip(),
                source='reddit_adapted',
                target_gender=gender,
                target_age=age,
                created_at=datetime.now(),
                metadata={
                    'original_title': story.get('title', ''),
                    'score': story.get('score', 0),
                }
            ))
        
        return ideas
    
    async def _generate_ideas(
        self, 
        gender: str, 
        age: str, 
        count: int
    ) -> list[IdeaItem]:
        """Generate new ideas using LLM."""
        prompt = f"""
        Generate {count} creative video ideas for {gender} aged {age}.
        Format as a numbered list.
        """
        
        response = self.llm_provider.generate_completion(
            prompt=prompt,
            temperature=0.8,
            max_tokens=500
        )
        
        # Parse numbered list
        ideas = []
        for i, line in enumerate(response.strip().split('\n'), 1):
            if line.strip():
                # Remove numbering if present
                content = line.split('.', 1)[-1].strip()
                ideas.append(IdeaItem(
                    id=f"llm_{i:03d}",
                    content=content,
                    source='llm_generated',
                    target_gender=gender,
                    target_age=age,
                    created_at=datetime.now(),
                ))
        
        return ideas[:count]
```

## Testing

Test the stage independently without other pipeline components:

```python
import pytest
from unittest.mock import Mock
from datetime import datetime

@pytest.mark.asyncio
async def test_idea_generation_with_sources():
    """Test idea generation with source stories."""
    
    # Mock LLM provider
    mock_llm = Mock()
    mock_llm.generate_completion.return_value = "Adapted video idea"
    
    # Create stage
    stage = IdeaGenerationStage(llm_provider=mock_llm)
    
    # Prepare input with source stories
    input_data = IdeaGenerationInput(
        target_gender='women',
        target_age='18-23',
        idea_count=5,
        source_stories=[
            {'id': '123', 'title': 'Test Story', 'content': 'Test content'}
        ]
    )
    
    # Execute
    result = await stage.execute(input_data)
    
    # Verify output contract
    assert result.data.total_count >= 1
    assert result.data.adapted_count == 1
    assert result.metadata.status == StageStatus.COMPLETED
    
    # Verify idea structure
    idea = result.data.ideas[0]
    assert idea.id == 'reddit_123'
    assert idea.source == 'reddit_adapted'
    assert idea.target_gender == 'women'
    assert idea.target_age == '18-23'

@pytest.mark.asyncio
async def test_idea_generation_llm_only():
    """Test LLM-only idea generation."""
    
    mock_llm = Mock()
    mock_llm.generate_completion.return_value = """
    1. First idea
    2. Second idea
    3. Third idea
    """
    
    stage = IdeaGenerationStage(llm_provider=mock_llm)
    
    input_data = IdeaGenerationInput(
        target_gender='men',
        target_age='24-29',
        idea_count=3
    )
    
    result = await stage.execute(input_data)
    
    assert result.data.generated_count == 3
    assert all(i.source == 'llm_generated' for i in result.data.ideas)
```

## Input/Output JSON Examples

### Example Input JSON
```json
{
  "target_gender": "women",
  "target_age": "18-23",
  "idea_count": 20,
  "source_stories": [
    {
      "id": "abc123",
      "title": "Amazing Life Story",
      "content": "A compelling narrative about...",
      "score": 1500,
      "subreddit": "relationships"
    }
  ]
}
```

### Example Output JSON
```json
{
  "ideas": [
    {
      "id": "reddit_abc123",
      "content": "A short video about navigating relationships in your early 20s...",
      "source": "reddit_adapted",
      "target_gender": "women",
      "target_age": "18-23",
      "created_at": "2024-01-15T10:30:00",
      "metadata": {
        "original_title": "Amazing Life Story",
        "score": 1500
      }
    },
    {
      "id": "llm_001",
      "content": "Top 5 self-care tips for young women...",
      "source": "llm_generated",
      "target_gender": "women",
      "target_age": "18-23",
      "created_at": "2024-01-15T10:30:05",
      "metadata": {}
    }
  ],
  "total_count": 2,
  "adapted_count": 1,
  "generated_count": 1,
  "metadata": {
    "execution_time_ms": 1234.56
  }
}
```

## Development as Separate Repository

When developing this stage in its own repository:

1. **Repository Name**: `prismq-stage-01-idea-generation`

2. **Dependencies**:
   ```
   prismq-core>=1.0.0  # For contracts and interfaces
   openai>=1.0.0       # For LLM (or alternative)
   ```

3. **Entry Point**:
   ```python
   # main.py
   from stage import IdeaGenerationStage
   
   # Can be used standalone or in pipeline
   ```

4. **Testing**: Fully testable without other stages

5. **Deployment**: Can be deployed as microservice accepting JSON input/output
